import streamlit as st
import pdfplumber
import re

# --- CONFIGURACI√ìN DE P√ÅGINA ---
st.set_page_config(page_title="HBL Extractor V4.0 - Interno", page_icon="üß¨", layout="centered")

st.title("üß¨ Extractor HBLT - Sergio's Version")
st.markdown("""
### Herramienta para Internado
Sube los PDFs del **Barros Luco** (Orina, Cultivos, Gram, Bioqu√≠mica).
""")

# --- DICCIONARIO DE ABREVIACIONES ---
# Mapeo de nombre en PDF -> Nombre corto para tu resumen
ABREVIACIONES = {
    # Orina Completa
    "Glucosuria": "Glu.Orina", "Proteinuria": "Prot.Orina", "Cuerpos Cetonicos": "Cetonas",
    "Ph Urinario": "pH", "Leucocitos": "Leucos", "Nitritos": "Nitritos",
    "Eritrocito": "Eritrocitos", "Bacterias": "Bacterias", "Celulas Epiteliales": "Cel.Epit",
    "Densidad": "Densidad",
    
    # Microbiolog√≠a / General
    "Vial Aerobio Adulto": "Hemocultivo",
    "Urocultivo": "Urocultivo",
    "Tincion De Gram": "Gram",
    "Staphylococcus Aureus": "S. Aureus",
    
    # Antibi√≥ticos (para acortar en el resumen)
    "Clindamicina": "Clinda", "Eritromicina": "Eritro", 
    "Oxacilina": "Oxacilina", "Rifampicina": "Rifam",
    "Trimetoprim-Sulfametoxazol": "Cotrimoxazol"
}

# Palabras clave para detectar antibiograma y status S/R
ANTIBIOTICOS_KEY = ["Clindamicina", "Eritromicina", "Oxacilina", "Rifampicina", "Trimetoprim", "Vancomicina", "Ciprofloxacino"]

def limpiar_linea(linea):
    """Elimina caracteres basura y espacios extra."""
    linea = linea.replace(':', '').replace('*', '').strip()
    return linea

def procesar_pdf(archivo_bytes):
    resultados = []
    seen = set()
    antibiograma_encontrado = False
    
    with pdfplumber.open(archivo_bytes) as pdf:
        for page in pdf.pages:
            # 1. INTENTO DE EXTRACCI√ìN POR TABLAS (Mejor para antibiogramas y orina)
            tables = page.extract_tables()
            for table in tables:
                for row in table:
                    # Limpiar None y unir texto
                    row_clean = [str(cell).strip() for cell in row if cell]
                    if not row_clean: continue
                    
                    # L√≥gica para Antibiograma (Ej: Clindamicina <=0.25 R)
                    # Buscamos si el primer elemento es un antibi√≥tico conocido
                    first_cell = row_clean[0].title()
                    is_abx = any(abx in first_cell for abx in ANTIBIOTICOS_KEY)
                    
                    if is_abx and len(row_clean) >= 2:
                        # Intentar buscar la S o R en la fila
                        sensibilidad = "Indet"
                        if "S" in row_clean: sensibilidad = "S"
                        elif "R" in row_clean: sensibilidad = "R"
                        elif "I" in row_clean: sensibilidad = "I"
                        
                        # Guardar formato: Clinda(R)
                        nombre_corto = ABREVIACIONES.get(first_cell, first_cell)
                        resultados.append(f"{nombre_corto}({sensibilidad})")
                        antibiograma_encontrado = True

            # 2. EXTRACCI√ìN POR TEXTO (Para resultados generales y microbiolog√≠a)
            text = page.extract_text(layout=True) # layout=True mantiene la posici√≥n espacial
            if not text: continue
            
            lines = text.split('\n')
            
            # Variables de estado para bloques de texto multil√≠nea
            capturando_gram = False
            
            for line in lines:
                line = limpiar_linea(line)
                if not line: continue
                
                # --- FILTROS DE BASURA ---
                ignorar = ["Hospital", "Barros", "Luco", "RUT", "Paciente", "Validado", "Fecha", "P√°gina", "Firma", "Ministerio", "Salud"]
                if any(x.upper() in line.upper() for x in ignorar): continue
                if re.search(r'\d{2}/\d{2}/\d{4}', line): continue # Fechas

                # --- L√ìGICA MICROBIOLOG√çA ---
                
                # A. Urocultivo / Hemocultivo
                # Detectar frase "Resultado Positivo" o "Resultado Negativo" asociado a cultivo
                if "Vial Aerobio" in line or "Urocultivo" in line:
                    # A veces viene "Estudio : Urocultivo" y luego en otra linea el resultado
                    # Simplificaci√≥n: Buscar palabras clave en la misma l√≠nea o l√≠neas cercanas es complejo sin estado,
                    # pero en tus PDFs el resultado suele estar cerca.
                    pass 

                # Si la l√≠nea dice expl√≠citamente el resultado del cultivo
                if line.startswith("Resultado") and ("Positivo" in line or "Negativo" in line):
                     resultados.append(f"Cultivo {line.replace('Resultado', '').strip()}")

                # B. Identificaci√≥n del Germen (Ej: Staphylococcus aureus)
                # Si encontramos un germen com√∫n, lo agregamos
                if "Staphylococcus" in line or "Escherichia" in line or "Klebsiella" in line:
                    # Limpiamos el nombre
                    germen = line.replace("1 ", "").strip() # Quitar numeraci√≥n si existe
                    # Chequear diccionario
                    for k, v in ABREVIACIONES.items():
                        if k.upper() in germen.upper():
                            germen = v
                    resultados.append(f"Germen: {germen}")

                # C. Tinci√≥n de Gram (Captura narrativa)
                if "Tincion de Gram" in line:
                    capturando_gram = True
                    continue
                
                if capturando_gram:
                    # Asumimos que las siguientes 1-2 l√≠neas son el resultado del Gram
                    # Hasta encontrar algo que parezca "Validado" o fin de secci√≥n
                    if "Validado" in line or "Dra." in line:
                        capturando_gram = False
                    elif len(line) > 5:
                        resultados.append(f"Gram: {line}")
                        capturando_gram = False # Captura solo la primera l√≠nea relevante

                # --- L√ìGICA ORINA COMPLETA Y BIOQU√çMICA (Regex mejorado) ---
                # Busca: PALABRA (espacio) VALOR (espacio) UNIDAD/TEXTO
                # Ej: "GLUCOSURIA 100 mg/dL" o "NITRITOS Negativo"
                
                # Regex Explicaci√≥n:
                # ^([A-Za-z\s]+?) -> Grupo 1: Nombre del examen (letras y espacios al inicio)
                # \s+             -> Separador obligatorio
                # (-?\d+[.,]?\d*|Negativo|Positivo|Ambar|Claro|Escasa|Regular|Abundante) -> Grupo 2: Valor num√©rico o cualitativo
                
                match = re.search(r'^([A-Za-z\s/]+?)\s+(-?\d+[.,]?\d*|Negativo|Positivo|Normal|Ambar|Claro|Limpido|Turbio|Escasa|Regular|Abundante)', line, re.IGNORECASE)
                
                if match and not antibiograma_encontrado: # Si es antibiograma, no usar este regex
                    nombre = match.group(1).strip().title()
                    valor = match.group(2).strip()
                    
                    # Filtros de falsos positivos
                    if len(nombre) < 3: continue
                    if "Solicitud" in nombre or "Procedencia" in nombre: continue
                    
                    # Normalizaci√≥n
                    nombre_final = ABREVIACIONES.get(nombre, nombre)
                    
                    # Formatear salida
                    res_str = f"{nombre_final} {valor}"
                    if res_str not in seen:
                        resultados.append(res_str)
                        seen.add(res_str)

    # Ordenar y limpiar salida final
    # Priorizar Cultura y Gram al principio si existen
    return " // ".join(resultados)

# --- INTERFAZ ---
archivo = st.file_uploader("üìÇ Sube tu PDF del HBLT", type="pdf")

if archivo:
    with st.spinner("Analizando con l√≥gica cl√≠nica..."):
        try:
            texto_extraido = procesar_pdf(archivo)
            
            if texto_extraido:
                st.success("‚úÖ Datos extra√≠dos")
                st.text_area("Copia y pega en tu evoluci√≥n:", value=texto_extraido, height=150)
            else:
                st.warning("‚ö†Ô∏è No pude leer datos claros. Verifica que sea un PDF de lab HBLT original.")
                
        except Exception as e:
            st.error(f"Error: {e}")
